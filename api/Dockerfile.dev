# Stage 1: Build & Development Environment
FROM golang:1.22-bookworm AS builder

# Install Air for hot-reloading (Crucial for DX)
RUN go install github.com/air-verse/air@latest

WORKDIR /app

# 1. Dependency Caching (SLA Layer)
# We copy only the mod files first to cache the 'go mod download' layer
COPY go.mod go.sum ./
RUN go mod download

# 2. Protobuf Tooling
# Necessary for generating the Go gRPC client from the .proto contract
RUN apt-get update && apt-get install -y protobuf-compiler && \
    go install google.golang.org/protobuf/cmd/protoc-gen-go@latest && \
    go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

# Copy the rest of the source
COPY . .

# Environment Agnosticism: API defaults
ENV PORT=8080
ENV AGENT_SOCKET=/var/run/kari/agent.sock

# Expose the API port
EXPOSE 8080

# Use Air for live-reloading during development
# It will watch for file changes, recompile, and restart the Brain automatically.
CMD ["air", "-c", ".air.toml"]

services:
  # ============================================================================
  # üóÑÔ∏è Database: PostgreSQL 16
  # ============================================================================
  db:
    image: postgres:16-alpine
    container_name: kari-db
    environment:
      POSTGRES_USER: kari_admin
      POSTGRES_PASSWORD: dev_password_only
      POSTGRES_DB: kari
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./api/internal/db/migrations:/docker-entrypoint-initdb.d
    networks:
      - kari-internal

  # ============================================================================
  # ‚öôÔ∏è The Muscle: Rust Agent
  # ============================================================================
  agent:
    build:
      context: .
      dockerfile: agent/Dockerfile.dev
    container_name: kari-agent
    privileged: true # Required to simulate systemd/jailing logic locally
    volumes:
      # The Shared Socket: This is the SLA boundary
      - kari_run:/var/run/kari
      # Simulated OS paths for Nginx/SSL testing
      - ./dev_root/etc/nginx:/etc/nginx
      - ./dev_root/etc/kari/ssl:/etc/kari/ssl
    networks:
      - kari-internal

  # ============================================================================
  # üß† The Brain: Go API
  # ============================================================================
  api:
    build:
      context: .
      dockerfile: api/Dockerfile.dev
    container_name: kari-api
    depends_on:
      - db
      - agent
    environment:
      DATABASE_URL: postgres://kari_admin:dev_password_only@db:5432/kari?sslmode=disable
      JWT_SECRET: dev_secret_for_testing_only
      PORT: "8080"
      # Platform Agnostic: Go points to the shared socket path
      AGENT_SOCKET: /var/run/kari/agent.sock
    ports:
      - "8080:8080"
    volumes:
      - kari_run:/var/run/kari
    networks:
      - kari-internal

  # ============================================================================
  # üíª The UI: SvelteKit
  # ============================================================================
  ui:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: kari-ui
    environment:
      VITE_API_URL: http://localhost:8080
    ports:
      - "5173:5173"
    networks:
      - kari-internal

networks:
  kari-internal:
    driver: bridge

volumes:
  postgres_data:
  # This volume facilitates the gRPC communication over Unix Sockets
  kari_run:
